{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div style="max-width: 1400px; margin: 0 auto; padding-bottom: 60px;">
    
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px;">
        <div>
            <span style="color: var(--primary); font-weight: 800; letter-spacing: 2px; text-transform: uppercase; font-size: 0.85rem;">Intelligence Suite</span>
            <h1 style="color: white; font-weight: 900; font-size: 3rem; letter-spacing: -2px;">Executive <span style="color: var(--primary);">Dashboard.</span></h1>
        </div>
        <div style="display: flex; gap: 15px;">
            <a href="{% url 'manage_products' %}" style="text-decoration: none; color: white; background: var(--primary); padding: 14px 28px; border-radius: 16px; font-weight: 800; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4); transition: 0.3s;">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path></svg>
                Inventory Control
            </a>
            <a href="/admin/" target="_blank" style="text-decoration: none; color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.05); padding: 14px 28px; border-radius: 16px; font-weight: 700; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px);">Core Admin</a>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 40px;">
        <div style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); padding: 30px; border-radius: 30px; position: relative; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
            <p style="color: rgba(255,255,255,0.7); font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">Gross Revenue</p>
            <h2 style="color: white; font-size: 2.2rem; font-weight: 900; margin-top: 10px;">₹{{ total_revenue }}</h2>
            <div style="position: absolute; right: -10px; bottom: -10px; opacity: 0.1; color: var(--primary);"><svg width="80" height="80" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 14h-2v-2h2v2zm0-4h-2V7h2v5z"></path></svg></div>
        </div>
        
        <div style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(25px); padding: 30px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
            <p style="color: rgba(255,255,255,0.7); font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">Volume (Orders)</p>
            <h2 style="color: white; font-size: 2.2rem; font-weight: 900; margin-top: 10px;">{{ total_orders }}</h2>
        </div>

        <div style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(25px); padding: 30px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
            <p style="color: rgba(255,255,255,0.7); font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">Active Catalog</p>
            <h2 style="color: white; font-size: 2.2rem; font-weight: 900; margin-top: 10px;">{{ total_products }}</h2>
        </div>

        <div style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(25px); padding: 30px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.3);">
            <p style="color: rgba(255,255,255,0.7); font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;">Customer Base</p>
            <h2 style="color: white; font-size: 2.2rem; font-weight: 900; margin-top: 10px;">{{ total_users }}</h2>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        
        <div style="background: white; border-radius: 40px; padding: 40px; box-shadow: 0 30px 60px rgba(0,0,0,0.4);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h3 style="color: #0f172a; font-weight: 900; font-size: 1.6rem; letter-spacing: -0.5px;">Sales Velocity Analysis</h3>
                <span style="color: #15803d; background: #dcfce7; padding: 6px 15px; border-radius: 50px; font-weight: 800; font-size: 0.8rem;">Live Tracking</span>
            </div>
            <div style="height: 400px; position: relative;">
                <canvas id="salesTrendChart"></canvas>
            </div>
        </div>

        <div style="background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(25px); border-radius: 40px; padding: 35px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <h3 style="font-weight: 800; margin-bottom: 25px; font-size: 1.4rem;">Inventory Alerts</h3>
            {% if low_stock_products %}
                <div style="display: flex; flex-direction: column; gap: 15px;">
                {% for prod in low_stock_products %}
                    <div style="background: rgba(255, 255, 255, 0.08); padding: 20px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255, 255, 255, 0.05);">
                        <div>
                            <p style="font-weight: 700; font-size: 1rem;">{{ prod.name }}</p>
                            <p style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">Category: {{ prod.category.name }}</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="{% if prod.stock == 0 %}background: #7f1d1d; color: #fca5a5;{% else %}background: #fee2e2; color: #b91c1c;{% endif %} padding: 8px 14px; border-radius: 12px; font-weight: 900; font-size: 0.85rem;">
                                {% if prod.stock == 0 %}OUT OF STOCK{% else %}STOCK: {{ prod.stock }}{% endif %}
                            </span>
                        </div>
                    </div>
                {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 40px 0;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">✅</div>
                    <p style="color: rgba(255,255,255,0.5); font-weight: 600;">Inventory is optimized.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div style="margin-top: 40px; background: rgba(15, 23, 42, 0.45); border-radius: 40px; padding: 40px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(25px); box-shadow: 0 30px 60px rgba(0,0,0,0.4);">
        <h3 style="color: white; font-weight: 800; margin-bottom: 30px; font-size: 1.6rem;">Recent Global Transactions</h3>
        <table style="width: 100%; border-collapse: separate; border-spacing: 0 10px; color: white; text-align: left;">
            <thead>
                <tr style="color: rgba(255,255,255,0.5); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">
                    <th style="padding: 15px;">Transaction Ref</th>
                    <th style="padding: 15px;">Client Profile</th>
                    <th style="padding: 15px;">Gross Amount</th>
                    <th style="padding: 15px; text-align: center;">Logistics Status</th>
                </tr>
            </thead>
            <tbody>
                {% for order in recent_orders %}
                <tr style="background: rgba(255,255,255,0.08); transition: 0.3s; border: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 20px; border-radius: 15px 0 0 15px; font-weight: 800; color: var(--primary);">#NMV-{{ order.id }}</td>
                    <td style="padding: 20px; font-weight: 600;">{{ order.user.username }}</td>
                    <td style="padding: 20px; font-weight: 900; font-size: 1.1rem;">₹{{ order.total_amount }}</td>
                    <td style="padding: 20px; border-radius: 0 15px 15px 0; text-align: center;">
                        <form action="{% url 'update_order_status' order.id %}" method="POST">
                            {% csrf_token %}
                            <select name="status" onchange="this.form.submit()" style="padding: 10px 18px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: #0f172a; color: white; font-weight: 700; cursor: pointer;">
                                <option value="Pending" {% if order.status == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="Shipped" {% if order.status == 'Shipped' %}selected{% endif %}>Shipped</option>
                                <option value="Delivered" {% if order.status == 'Delivered' %}selected{% endif %}>Delivered</option>
                                <option value="Cancelled" {% if order.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const ctx = document.getElementById('salesTrendChart').getContext('2d');
        const chartData = {{ chart_amounts|safe }};
        
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(37, 99, 235, 0.4)');
        gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_dates|safe }},
                datasets: [{
                    label: 'Revenue Stream',
                    data: chartData,
                    borderColor: '#2563eb',
                    backgroundColor: gradient,
                    borderWidth: 5,
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#2563eb',
                    pointBorderWidth: 3,
                    pointRadius: 6,
                    pointHoverRadius: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { callback: v => '₹' + v.toLocaleString('en-IN'), font: { weight: '800' } }
                    },
                    x: { grid: { display: false }, ticks: { font: { weight: '700' } } }
                }
            }
        });
    });
</script>
{% endblock %}